services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    command: tunnel --no-autoupdate --url http://faucet:3001
    networks:
      - secret-network
    restart: unless-stopped
    depends_on:
      faucet:
        condition: service_healthy

  dashboard:
    image: ghcr.io/mrgarbonzo/dash.scrt.network:latest
    container_name: secret-dashboard
    ports:
      - 3000:3000
    environment:
      VITE_FAUCET_URL: ${VITE_FAUCET_URL:-http://faucet:3001/claim}
      VITE_FAUCET_ADDRESS: ${VITE_FAUCET_ADDRESS}
      VITE_MIXPANEL_ENABLED: ${VITE_MIXPANEL_ENABLED:-false}
      VITE_MIXPANEL_PROJECT_TOKEN: ${VITE_MIXPANEL_PROJECT_TOKEN:-}
      VITE_DEBUG_MODE: ${VITE_DEBUG_MODE:-false}
      TRANSAK_API_KEY: ${TRANSAK_API_KEY:-}
    networks:
      - secret-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3000/
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    depends_on:
      faucet:
        condition: service_healthy
    env_file:
      - usr/.env

  faucet:
    image: ghcr.io/mrgarbonzo/feegrantfaucet2.0:latest
    container_name: feegrant-faucet
    ports:
      - 3001:3001
    environment:
      CHAIN_ID: ${CHAIN_ID:-secret-4}
      LCD_NODE: ${LCD_NODE}
      PORT: ${PORT:-3001}
      FAUCET_AMOUNT: ${FAUCET_AMOUNT:-50000}
      FAUCET_DENOM: ${FAUCET_DENOM:-uscrt}
      FAUCET_RELOAD_TIME: ${FAUCET_RELOAD_TIME:-24}
      GAS_FEE: ${GAS_FEE:-0.5}
      GAS_DENOM: ${GAS_DENOM:-uscrt}
      GAS_LIMIT: ${GAS_LIMIT:-17500}
      MEMO: ${MEMO:-Fee Grant provided by Secret Network Dashboard}
      FAUCET_MNEMOMIC: ${FAUCET_MNEMOMIC}
    networks:
      - secret-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - node
        - -e
        - "require('http').get('http://localhost:3001/', (r) =>
          {process.exit(r.statusCode === 200 ? 0 : 1)})"
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    env_file:
      - usr/.env

networks:
  secret-network:
    driver: bridge
